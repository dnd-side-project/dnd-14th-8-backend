# TDD 기반 모임 일정 조회 API 개발 세션 정리 (상세)

## 📋 개발 목표
- `getMeetingSchedules` API 엔드포인트 개발
- TDD(Test-Driven Development) 방법론 첫 적용

---

## 🎯 1. TDD 기본 개념

### TDD 사이클 (Red → Green → Refactor)
| 단계 | 설명 |
|------|------|
| Red | 실패하는 테스트 먼저 작성 |
| Green | 테스트 통과하는 최소한의 코드 구현 |
| Refactor | 코드 정리 |

### Q. 존재하지 않는 DTO, 메서드를 테스트에서 먼저 작성해도 되나?
**A. 그게 TDD의 핵심.** 컴파일조차 안 되는 상태에서 시작. IDE에서 빨간불 뜨면 `Alt+Enter`로 클래스/메서드 자동 생성하면서 진행.

### Q. 테스트에서 `@Transactional` 붙이는 이유?
**A. 테스트 격리.** 각 테스트 후 자동 롤백되어 DB 수동 정리 불필요. 단, 같은 트랜잭션 안에서 1차 캐시로 조회되는 함정 주의.

---

## 🎯 2. 테스트 종류와 전략 (많이 고민한 부분)

### Q. 단위 테스트 vs 통합 테스트 차이?
| 구분 | 단위 테스트 | 통합 테스트 |
|------|-------------|-------------|
| DB | Mock 사용 | 실제 DB (H2) |
| 속도 | 빠름 | 느림 |
| 검증 범위 | Service 로직만 | 전체 흐름 (쿼리 포함) |
| 어노테이션 | `@ExtendWith(MockitoExtension.class)` | `@SpringBootTest` |

### Q. 통합 테스트 먼저 하고 단위 테스트 나중에 하는 게 일반적인가?
**A. 일반적으로는 반대 (단위 → 통합).** 하지만 프로젝트 초기/작은 팀에서는 통합 테스트 먼저도 현실적. 정답 없고 상황에 따라.

### Q. 내부에서 여러 서비스 호출하는데 테스트 코드에서는 그냥 호출만 하면 되나?
**A. 통합 테스트는 내부 로직 전부 실행됨.** 단위 테스트는 Mock으로 의존성 격리해서 해당 메서드 로직만 테스트.

### Q. 테스트 파일 분리 vs @Nested 사용?
| 상황 | 추천 |
|------|------|
| 같은 서비스, 같은 설정, 테스트 30개 미만 | `@Nested`로 그룹화 |
| 테스트 30개 이상 또는 설정 다름 | 파일 분리 |

---

## 🎯 3. Mock 개념과 사용법 (가장 오래 막힌 부분)

### Q. Mock이 뭐야? 어떻게 동작해?
**A. 가짜 객체.** 진짜처럼 행동하지만 실제로는 아무것도 안 함.

```java
@Mock
private MeetingRepository meetingRepository;  // 가짜 객체 (DB 연결 X)

@InjectMocks
private MeetingServiceImpl meetingService;    // 진짜 객체 (위 Mock 주입됨)
```

### Q. `when().thenReturn()`은 뭐야?
**A. "이 메서드 호출되면 이거 반환해"라고 설정하는 것.**

```java
when(meetingRepository.findById("test-id"))
    .thenReturn(Optional.of(fakeMeeting));
// 이제 findById("test-id") 호출하면 fakeMeeting 반환
```

### Q. `meetingService.getMeetingSchedules()` 호출하면 실제 DB 가는 거 아니야?
**A. 실제 Service 로직은 실행됨.** 하지만 내부에서 호출하는 `meetingRepository`가 Mock이라 DB 안 감. Mock이 가로채서 설정한 값 반환.

```
getMeetingSchedules() 호출
    ↓
MeetingServiceImpl (진짜) - 로직 실행
    ↓
meetingRepository.findById() 호출
    ↓
Mock이 가로챔 → when()에서 설정한 값 반환
    ↓
DB 안 감 ❌
```

### Q. `findById()` 메서드를 내가 안 만들면?
**A. Mock은 인터페이스의 모든 메서드 시그니처를 복사한 가짜 객체 생성.** `JpaRepository`가 이미 `findById()` 제공하므로 있음. 진짜 없는 메서드면 컴파일 에러.

| 상황 | 결과 |
|------|------|
| 메서드 있음 + when() 설정 | 설정한 값 반환 |
| 메서드 있음 + when() 없음 | 기본값 (null, empty 등) |
| 메서드 없음 | 컴파일 에러 |

---

## 🎯 4. DTO 설계 관련 질문들

### Q. DTO 안에 또 DTO를 필드로 두는 게 나을까, 플랫하게 받는 게 나을까?
| 상황 | 추천 |
|------|------|
| 논리적 그룹이 명확함 (SchedulePoll은 하나의 개념) | **중첩 DTO** |
| 재사용 가능성 있음 | **중첩 DTO** |
| 필드 몇 개 안 됨, 단순 조회용 | 플랫 |

### Q. DTO 안에서 엔티티로 받으면 안 돼?
**A. 절대 X.**

| 문제 | 설명 |
|------|------|
| 불필요한 정보 노출 | createdAt, updatedAt 등 내부 정보 |
| 순환 참조 | SchedulePoll → Meeting → SchedulePoll → ... |
| 엔티티 변경 = API 스펙 변경 | 분리 안 됨 |
| Lazy Loading 문제 | 트랜잭션 밖에서 LazyInitializationException |

### Q. `GetMeetingScheduleResponse` 내부 Participant DTO 이름 추천?
- `ParticipantInfo` - 가장 일반적
- `ParticipantSummary` - 요약 정보
- 내부 클래스 `GetMeetingScheduleResponse.Participant` - 재사용 안 할 때

### Q. record 타입이 Builder 지원 안 하나?
**A. 기본적으로 없음.** 하지만 방법 있음:
- 그냥 생성자 사용
- **정적 팩토리 메서드 `from()` (추천)** - 엔티티 → DTO 변환
- `@Builder` 붙이기 (가능은 함)

### Q. `CreateMeetingRequest` 같은 DTO를 record로 만들면 생성자로 그냥 생성되는데 괜찮아?
**A. DTO라서 괜찮음.** 엔티티는 빌더/팩토리로 제한하지만, DTO는 단순 데이터 전달 목적. 검증은 `@Valid` + Bean Validation이 처리.

---

## 🎯 5. 연관관계 조회 방법

### Q. QueryDSL 꼭 써야 해? 과한 것 같은데.
**A. 안 써도 됨.** 복잡한 쿼리 2~3개면 다른 방법으로 충분.

| 방법 | 설명 |
|------|------|
| JPQL + JOIN FETCH | `@Query`로 직접 작성 |
| @EntityGraph | 어노테이션으로 Eager 로딩 지정 |
| Lazy Loading | 트랜잭션 안에서 접근, 데이터 적으면 OK |
| 전역 batch_fetch_size | N+1 최적화, 설정만 추가 |

### Q. `List<LocalDateTime>`에 `List<LocalDateTime>` 자체를 추가할 수 없나?
**A. `add()`는 단일 요소만.** `addAll()` 사용:
```java
list1.addAll(list2);  // list2의 모든 요소를 list1에 추가
```

---

## 🎯 6. 비즈니스 로직 설계 고민

### Q. 투표한 참가자 수 - 엔티티에 상태값 추가 vs DTO에서 계산?
**A. DTO에서 계산 추천.**

| 방식 | 문제점 |
|------|--------|
| 엔티티에 `hasVoted` 추가 | 투표할 때마다 업데이트 필요, 정합성 관리 복잡 |
| **DTO에서 계산** | ScheduleVote 존재 여부로 판단, 실제 데이터 기반 |

```java
long votedCount = meeting.getParticipants().stream()
    .filter(p -> !p.getScheduleVotes().isEmpty())
    .count();
```

### Q. 엔티티나 DTO 필드에 주석 다는 게 정석인가?
**A. 보통 불필요.** 좋은 필드명 > 주석. 단, 단위 불명확하거나 비즈니스 규칙 있으면 주석 필요. DB 컬럼은 `@Column(comment=...)` 활용.

---

## 🚨 7. 막혔던 에러와 해결

### 에러 1: 테스트에서 response가 null
**원인:** `getMeetingSchedules()`가 `return null;` 상태 (아직 구현 안 함)
**해결:** 이게 정상. Red 단계. 구현하면 Green.

### 에러 2: Mock 설정했는데 "모임을 찾을 수 없습니다" 예외
**원인:** 메서드명 불일치
```java
// 테스트에서 Mock 설정
when(meetingRepository.findById(meetingId))...

// 실제 구현
meetingRepository.findByIdWithScheduleDetails(meetingId)  // 다른 메서드!
```
**해결:** Mock은 정확히 설정한 메서드만 동작. 메서드명 일치시켜야 함.

### 에러 3: `getScheduleVotes()`가 null - NPE 발생
**원인:** Lombok `@Builder.Default` 누락
```java
// @Builder.Default 없으면
private List<ScheduleVote> scheduleVotes = new ArrayList<>();
// Builder로 생성 시 → null (초기화 무시됨!)
```
**해결:** `@Builder.Default` 추가. `SchedulePoll.defaultOf()` 내부에서 Builder 사용 중이라 영향 받음.

### 에러 4: Lombok 경고 3개 발생
```
LocationPoll.java:43: warning: @Builder will ignore the initializing expression...
Participant.java:35: warning: ...
Participant.java:38: warning: ...
```
**원인:** 다른 엔티티들도 같은 `@Builder.Default` 누락 문제
**해결:** 해당 필드에 `@Builder.Default` 추가 필요

### 에러 5: MultipleBagFetchException
**원인:** 2개 이상의 `List`(Bag)를 동시에 JOIN FETCH
```java
LEFT JOIN FETCH m.participants      -- List
LEFT JOIN FETCH sp.scheduleVotes    -- List  ← 동시에 안 됨!
```
**해결 옵션:**
| 방법 | 설명 |
|------|------|
| List → Set 변경 | 가장 간단, 순서 불필요하면 |
| 쿼리 분리 | 여러 번 쿼리 |
| @BatchSize | N+1 최적화 |
| 전역 batch_fetch_size | 설정만 추가 |
| @Fetch(SUBSELECT) | 서브쿼리로 조회 |
| 그냥 Lazy Loading | 데이터 적으면 OK |
| DTO Projection | 엔티티 안 거치고 DTO 직접 조회 |

---

## 💡 8. 얻은 인사이트

1. **TDD는 설계를 주도한다** - 테스트 먼저 작성하면 "이 API는 이렇게 응답해야 해"를 먼저 정의하게 됨

2. **Mock은 정확히 설정한 것만 동작** - 메서드명, 파라미터 정확히 일치해야 함

3. **Lombok @Builder 사용 시 컬렉션 필드 주의** - `@Builder.Default` 없으면 초기화 무시됨

4. **엔티티와 DTO는 반드시 분리** - 순환참조, 정보노출, LazyLoading 문제

5. **상태값 추가보다 실제 데이터 기반 계산** - 정합성 보장, 중복 데이터 없음

6. **QueryDSL 없이도 연관관계 조회 가능** - JPQL, EntityGraph, Lazy Loading 등

7. **테스트 전략은 상황에 따라** - 프로젝트 초기엔 통합 테스트 먼저도 현실적

8. **MultipleBagFetchException** - 여러 List 동시 fetch 불가, Set 변경 또는 쿼리 분리

---

## 📁 9. 작성/수정한 파일

| 파일 | 설명 |
|------|------|
| `MeetingServiceUnitTest.java` | 단위 테스트 (Mock 사용) - 6개 테스트 |
| `MeetingServiceIntegrationTest.java` | 통합 테스트 추가 (@Nested) - 5개 테스트 |
| `GetMeetingScheduleResponse.java` | 응답 DTO (직접 작성) |
| `MeetingServiceImpl.java` | getMeetingSchedules 구현 (직접 작성) |
| `MeetingRepository.java` | findByIdWithScheduleDetails 쿼리 (직접 작성) |
| `SchedulePoll.java` | @Builder.Default 추가 |

---

## 🔜 10. 내일 이어서 할 것

- [ ] MultipleBagFetchException 해결 방안 선택 및 적용
- [ ] 통합 테스트 통과시키기
- [ ] 다른 엔티티들 `@Builder.Default` 추가 (LocationPoll, Participant)
