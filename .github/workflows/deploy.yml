name: Deploy to Naver Cloud

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build with Gradle
      run: ./gradlew clean build -x test

    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.NCP_REGISTRY_URL }}/moyeorak-backend:latest \
          -t ${{ secrets.NCP_REGISTRY_URL }}/moyeorak-backend:${{ github.sha }} .

    - name: Login to NCP Container Registry
      run: |
        echo ${{ secrets.NCP_REGISTRY_PASSWORD }} | docker login ${{ secrets.NCP_REGISTRY_URL }} \
          -u ${{ secrets.NCP_REGISTRY_USERNAME }} --password-stdin

    - name: Push Docker image
      run: |
        docker push ${{ secrets.NCP_REGISTRY_URL }}/moyeorak-backend:latest
        docker push ${{ secrets.NCP_REGISTRY_URL }}/moyeorak-backend:${{ github.sha }}

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.NCP_SERVER_HOST }}
        username: ${{ secrets.NCP_SERVER_USERNAME }}
        key: ${{ secrets.NCP_SERVER_SSH_KEY }}
        script: |
          cd /root/moyeorak

          echo ${{ secrets.NCP_REGISTRY_PASSWORD }} | docker login ${{ secrets.NCP_REGISTRY_URL }} \
            -u ${{ secrets.NCP_REGISTRY_USERNAME }} --password-stdin

          docker pull ${{ secrets.NCP_REGISTRY_URL }}/moyeorak-backend:latest

          docker-compose down backend

          docker-compose up -d backend

          docker image prune -f

          echo "Deployment completed!"
          docker ps | grep moyeorak-backend
