name: Deploy to Naver Cloud

on:
  push:
    branches:
      - main  # main 브랜치에 push될 때 실행
      - dev   # dev 브랜치에 push될 때 실행

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. 코드 체크아웃
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. JDK 25 설치
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'

    # 3. Gradle 빌드 (실행 권한 부여)
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 4. Spring Boot 애플리케이션 빌드
    - name: Build with Gradle
      run: ./gradlew clean build -x test

    # 5. Docker 이미지 빌드
    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.NCP_REGISTRY_URL }}/moyeorak-backend:latest \
          -t ${{ secrets.NCP_REGISTRY_URL }}/moyeorak-backend:${{ github.sha }} .

    # 6. Naver Cloud Container Registry 로그인
    - name: Login to NCP Container Registry
      run: |
        echo ${{ secrets.NCP_REGISTRY_PASSWORD }} | docker login ${{ secrets.NCP_REGISTRY_URL }} \
          -u ${{ secrets.NCP_REGISTRY_USERNAME }} --password-stdin

    # 7. Docker 이미지 Push
    - name: Push Docker image
      run: |
        docker push ${{ secrets.NCP_REGISTRY_URL }}/moyeorak-backend:latest
        docker push ${{ secrets.NCP_REGISTRY_URL }}/moyeorak-backend:${{ github.sha }}

    # 8. 모니터링 설정 파일 서버에 전송
    - name: Copy monitoring configs to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.NCP_SERVER_HOST }}
        username: ${{ secrets.NCP_SERVER_USERNAME }}
        password: ${{ secrets.NCP_SERVER_PASSWORD }}
        source: "monitoring/,docker-compose.monitoring.yml"
        target: "/app/moyeorak"

    # 9. 서버에 SSH 접속하여 배포
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.NCP_SERVER_HOST }}
        username: ${{ secrets.NCP_SERVER_USERNAME }}
        password: ${{ secrets.NCP_SERVER_PASSWORD }}
        script: |
          cd /app/moyeorak

          # Container Registry 로그인
          echo ${{ secrets.NCP_REGISTRY_PASSWORD }} | docker login ${{ secrets.NCP_REGISTRY_URL }} \
            -u ${{ secrets.NCP_REGISTRY_USERNAME }} --password-stdin

          # 최신 이미지 Pull
          docker pull ${{ secrets.NCP_REGISTRY_URL }}/moyeorak-backend:latest

          # 기존 backend 컨테이너 중지 및 제거
          docker-compose down backend

          # 새 backend 컨테이너 시작
          docker-compose up -d backend

          # 모니터링 스택 시작 (이미 실행 중이면 유지)
          GRAFANA_ADMIN_USER=${{ secrets.GRAFANA_ADMIN_USER }} \
          GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }} \
          docker-compose -f docker-compose.monitoring.yml up -d

          # 사용하지 않는 이미지 정리
          docker image prune -f

          echo "Deployment completed!"
          docker ps | grep moyeorak
